%% This document (intended for clinicians) describes the data format
%% and submission process. With its contents, a contributor should be
%% able to
%%
%%  - Understand the data format being requested
%%  - Put their data in the desired format
%%  - Securely submit their data to SHARED

\documentclass{article}

\usepackage{graphicx}
\usepackage[utf8]{inputenc}
\usepackage{pmboxdraw}
\usepackage[titletoc,title]{appendix}
\usepackage{placeins}

\author{Nathaniel Knight}
\date{\today}

\title{SHARED Contributor Guide for Clinical Data}



\begin{document}

\maketitle


\begin{abstract}
  This document has information about \textbf{submitting clinical
    data} to the SHARED collaboration, including what to submit, how to
  format your data, and how to send it securely.
\end{abstract}

\newpage

\section{What SHARED Collects}

The SHARED database collects the demographic information, treatment
histories, clinical outcomes, and viral sequences of participants. In
very simple cases, where there is only \textbf{one record per
  participant}, these can be submitted as a single spreadsheet (this
arrangement is called the \textit{simple scheme}). For most cases, where
there might be \textbf{more than one} treatment record or viral
sequencing result for each participant, the data should be submitted
as multiple tables (this is called the \textit{multi-table schem}).

Each field in the submitted data will be either a number, a date, or a
string, which we descibe here for consistency:

\begin{description}
\item[number] A whole or decimal number. E.g: 1, 7.4, -12
\item[date] A date in the format YYYY-MM-DD. E.g: 2017-05-17,
  1969-07-20, 1980-05-08.
\item[text] A string of characters. If you need to include commas
  (e.g. in free-form notes) you must enclose the field in
  double-quotes. If you're using a program like Excel or a
  CSV-specific software (like \texttt{csv} in the Python standard
  library) this will probably be done automatically. E.g: 1a,
  sufosbuvir, ``The truth, the whole truth, and nothing but the
  truth.''.
\end{description}

Fields that are \textbf{required} are marked with a bullet (•) in the
descriptions below.  Other fields can be left out, indicating that the
data wasn't collected or is unknown (they'll be stored as
\texttt{NULL} in the database). The \textbf{clinical data table} in
particular has many columns; we don't expect that anyone will have
them all. If you don't collect a particular kind of data, you should
\textbf{omit} the column.

Each column of your data table should have a \textbf{header} with the
column name. The \textbf{order} of the columns doesn't matter, and any
extra columns will be ignored. The \textbf{case} of the filenames and
header names also doesn't matter (they will all be converted to
lower-case before they're checked and loaded).

Genetic sequence data is expected in a \textbf{sub-directory} called
\texttt{sequences}. The FASTA file names in the examples are just
examples; you can use whatever naming convention is easiest for you,
as long as the filenames in \texttt{isolates.csv} match the files in
the \texttt{sequences/} directory.

Whichever scheme you use, your CSV/Excel and FASTA files should be
stored in a ZIP archive and sent via the SHARED project's website,
where it will be transmitted over an encrypted connection, reviewed,
and merged into the SHARED database. \textbf{DO NOT SUBMIT YOUR DATA
  VIA EMAIL}; we cannot guarantee that emails are always enrypted
while in transit.



\section{Simple Scheme}

If each participant has only a single clinical, behavior, and
treatment record, the simple scheme can be used. This is a single CSV
file or MS Excel sheet with the columns described in table
\ref{tbl:simple-scheme}. Required fields are marked with a bullt (•). We
don't expect anybody to have collected the data for every field;
fields that don't apply to your study can be omitted.

The file containing participant data should be called
\texttt{data}. Sequence data should be included as FASTA files in a
\textbf{sub-directory} called \texttt{sequences}. The layout of an
example data directory is shown in figure
\ref{fig:example-simple-directory}.

\begin{figure}
  \caption{Simple-Scheme Expected Files}
  \label{fig:simple-scheme-expected-files}
\begin{verbatim}
my_flat_data_prep_directory/
 ├── data.csv OR data.xls OR data.xlsx
 └── sequences/
     ├── seq1.fasta
     ├── seq2.fasta
     etc.
\end{verbatim}
\end{figure}

The fields expected in a simple scheme data file are as follows:

%% TODO(nknight): simple scheme table
\begin{table}
  \caption{Simple-Scheme Table Fields}
  \label{tbl:simple-scheme}
  coming soon
\end{table}


\section{Multi-Table Scheme}

If there are multiple clinical, behavior, or treatment records for a
single participant, the data can be recorded using the multi-table
scheme. Data in this scheme can be submitted as \textbf{separate CSV
  files} or as \textbf{sheets in an MS Excel} file. The expected
tables are listed in table \ref{tbl:multi-table-expected-tables}. The
relationships between these files are shown in figure
\ref{fig:relationships}.


\begin{table}[h!]
  \caption{The Multi-Table Scheme's Expected Tables}
  \label{tbl:multi-table-expected-tables}
  \begin{tabular}{rp{8cm}}
    Name (case insensitive) & Contents \\ \hline
    \verb|partcipants| & Participant ID codes and demographic data. \\
    \verb|behavior| &  Participants' behavioral risk factors. \\
    \verb|clinical| & Participants' test results and relevant clinical history. \\
    \verb|ltfu| & Records of loss-to-follow-up. \\
    \verb|treatment| &  Participants' treatment information. \\
    \verb|isolates| & Participants' viral isolate data (sequences stored separately). \\
  \end{tabular}
\end{table}

\begin{figure}
  \caption{Relationships between SHARED submission data files}
  \label{fig:relationships}
  \includegraphics[width=\textwidth]{tmp/clinical_relationships}
\end{figure}


The expected contents of each table are described below.


%% TODO(nknight): multi-scheme tables



\section{Submitting Data}

%% TODO(nknight): howto zipfiles footnote


\begin{figure}
  \caption{Layout of a SHARED submission data directory}
  \label{fig:data-prep-dir}
\begin{verbatim}
 my_data_prep_directory/
 ├── behavior.csv
 ├── clinical.csv
 ├── isolates.csv
 ├── ltfu.csv
 ├── partcipants.csv
 ├── treatment.csv
 └── sequences/
     ├── seq1.fasta
     ├── seq2.fasta
     etc.
\end{verbatim}
\end{figure}


\begin{table}[h!]
  \centering
  \caption{The \texttt{participants.csv} file's fields}
  \label{tbl:participants.csv}
  \begin{tabular}{cllp{6cm}p{4cm}}
    R & Name            & Type      & Description & Possible Values\\ \hline
    • & person          & text    &
      The \textbf{anonymous ID} used for the participant in this
      merge. It will be referred to in other CSV files to associate
      other kinds of data to this participant. The exact format of
      this field isn't particularly important as long as the keys in
      the other files \textbf{match}; use whatever works best for you
      (numbers, UUIDs, etc.). Note that keys are compared as
      \textbf{text}, so $"01" \neq "1"$ and $"1" \neq "1.0"$. 
      \\
      & country         & text    & The country where the person participated in the study. \\
      & city            & text    & The city where the participant participated in the study. \\
      & sex             & text    & The participant's sex at birth.  & male, female, other \\
      & ethnicity       & text    & The participant's ethnicity. & am-nat, asian, black, hisp, pa-isl, white \\
      & year\_of\_birth & integer   & The participant's year of birth. \\
  \end{tabular}
\end{table}


\begin{table}[h!]
  \centering
  \caption{The \texttt{behavior.csv} file's fields}
  \label{tbl:behavior.csv}
  \begin{tabular}{cllp{6cm}p{4cm}}
    R & Name        & Type          & Description & Possible Values\\ \hline
    • & person      & text        &
    The key to a person in the \texttt{participants.csv}
    file. \texttt{squishd.py} will check that all the participants in
    this file are present in the participants file. \\
      & date\_collected & date      & The date this data was collected. \\
      & sex\_ori        & text    & The participant's sexual orientation & heterosexual, homosexual, bisexual, other \\
      & idu             & bool      & Has the participant ever used injection drugs? \\
      & ndu             & bool      & Has the participant ever used non-injection drugs? \\
      & idu\_recent     & bool      & Has the participant used injection drugs in the past 6 months? \\
      & ndu\_recent     & bool      & Has the participant used non-injection drugs in the past 6 months? \\    
      & prison          & bool      & Has the participant ever been to prison? \\
  \end{tabular}
\end{table}


\begin{table}[h!]
  \centering
  \caption{The \texttt{clinical.csv} file's fields}
  \label{tbl:clinical.csv}
  \begin{tabular}{cllp{6cm}p{4cm}}
    R & Name        & Type      & Description & Possible Values\\ \hline
  • & person      & text    & The key to a person in the \texttt{participants.csv}
    file. \texttt{squishd.py} will check that all of the participants in this file
    are present in the participants file. \\
    & hiv           & bool      & Is the participant co-infected with HIV? & \\
    & hbv           & bool      & Is the participant co-infected with HBV? & \\
    & ost           & bool      & Has the participant undergone opioid substitution therapy in the last six months? &  \\
    & chir          & bool      & Does the participant have cirrhosis? & \\
    & metavir       & text      & Metavir score. & A0, A1, A2, A3, F0, F1, F2, F3, F4 \\
    & metavir\_by   & text      & Method used to determine metavir score. & Fibroscan, Biopsy, Clinical, Other \\
    & stiff         & number    & Liver stiffness (in kPa). & \\
    & alt           & number    & Alanine aminotransferase level (in U/L). & \\
    & ast           & number    & Aspartate aminotransferase level (in U/L). & \\
    & crt           & number    & Creatinine level (in $\mu$M/L). & \\
    & egfr          & number    & Estimated glomerular filtration rate (in mL/minBSAc). & \\
    & ctp           & number    & Child-Turcotte-Pugh score. & \\
    & meld          & number    & MELD score. & \\
    & ishak         & number    & Ishak score. & \\
    & bil           & number    & Bilirubin test result, in mg/dL. & \\
    & hemo          & number    & Hemoglobin test result, in g/dL. & \\
    & alb           & number    & Albumin test result, in g/dL. & \\
    & inr           & number    & International Normalized Ratio test result. & \\
    & phos          & number    & Phosphate test result, in mg/dL. & \\
    & urea          & number    & Urea test result, in ng/dL. & \\
    & plate         & number    & Platelet count, in cells/mm$^3$. & \\
    & CD4           & number    & CD4 count, in cells/mm$^3$. & \\
    & crp           & number    & C-Reactive Protein test result, in mg/L. & \\
    & il28b         & string    & The participant's IL28B-rs12979860 genotype. & TT, TC, CC \\
    & asc           & bool      & Did the participant have ascites before or during treatment? & \\
    & var\_bleed    & bool      & Did the participant have variceal bleeding before or during treatment? & \\
    & hep\_car      & bool      & Did the participant have hepatocellular carcinoma before or during treatment? & \\
    & transpl       & bool      & Has the participant had a liver transplant? & \\
  \end{tabular}
\end{table}


\begin{table}[h!]
  \centering
  \caption{The \texttt{ltfu.csv} file's fields}
  \label{tbl:ltfu.csv}
  \begin{tabular}{cllp{6cm}p{4cm}}
    R & Name            & Type      & Description & Possible Values \\ \hline
    • & person          & text      & The key to a person in the \texttt{participants.csv}
    file. \texttt{squishd.py} will check that all of the participants in this file
    are present in the participants file. & \\
      & ltfu\_dt        & date      & The date the participant was lost to follow up. & \\
      & died            & bool      & Is the participant deceased? & \\
      & cod             & text    & Cause of death (if applicable). & See Appendix \ref{apx:cod}.\\
  \end{tabular}
\end{table}


\begin{table}[h!]
  \centering
  \caption{The \texttt{treatment.csv} file's fields}
  \label{tbl:treatment.csv}
  \begin{tabular}{cllp{6cm}p{4cm}}
    R & Name                & Type      & Description   & Possible Values\\ \hline
    • & person              & text    & The key to a person in the \texttt{participants.csv}
    file. \texttt{squishd.py} will check that all of the participants in this file
    are present in the participants file. & \\
      & first\_treatment    & bool      & Is this the participant's first treatment? & \\
      & start\_dt           & date      & The treatment start date & \\
      & end\_dt\_sch        & date      & Scheduled treatment end date & \\
      & end\_dt\_act        & date      & Actual treatment end date (if different from scheduled). \\
      & end\_dt\_bound      & text    &
    Uncertainty on end\_dt\_bound (default is $=$). & $=, <, >$ \\
      & regimen             & text      & What drug regimen was the participant taking? & See Appendix \ref{apx:drug-regimens} \\
      & prev\_regimen       & text      & If the participant has been treated before, what treatment regimen were they taking previously?  & See Appendix \ref{apx:drug-regimens}. \\
      & pprev\_regimen      & text      & If the participant has had two previous treatments, what regimen were they taking before-last? & See Appendix \ref{apx:drug-regimens}. \\
      & response            & text      & How did the participant respond to treatment? & See Appendix \ref{apx:response} \\
      & notes               & text    & Additional notes (if required). & \\
  \end{tabular}
\end{table}


\begin{table}[h!]
  \centering
  \caption{The \texttt{isolates.csv} file's fields}
  \label{tbl:isolates.csv}
  \begin{tabular}{cllp{6cm}p{4cm}}
    R & Name        & Type      & Description & Possible Values\\ \hline
    • & person      & text    & The key to a person in the
    \texttt{participants.csv} file, indicating who this isolate came
    from. \texttt{squishd.py} will check that all of the participants
    in this file are present in the participants file. & \\
    • & seq\_file   & text    & The name of a FASTA file in the
    \texttt{sequences} folder containing the concensus sequence data for this viral isolate. & \\ 
    & genotype    & text    & The genotype of this viral isolate. &
    1, 2, 3, 4, 5, 6, mixed, indeterminate, recombinant \\
    & subgenotype & text    & The sub-genotype of this viral isolate. & \\
    & strain      & text    & The strain of this viral isolate. & \\
    • & method      & text    & The sequencing method used. & sanger, ngs \\
    • & cutoff      & number  & The cutoff value used to create the concensus sequence, as a percentage. & \\
    • & kind        & text    & Whether the sequence is from a baseline sample, an end-of-treatment sample, or a follow-up sample 4, 12, or 24 weeks after treatment. & bl, eot, fw4, fw12, fw24 \\
    & isln\_dt    & date      & The date this virus was isolated. & \\
    
  \end{tabular}
\end{table}



\section{Submitting Data}


%% TODO(nknight): walkthrough and screenshots of submission process
%% (why token, get token, use token)
%% TODO(nknight): footnotes on how to zipfiles

\FloatBarrier
\begin{appendices}

\newpage
\section{Detailed drug regimen information}
\label{apx:drug-regimens}

Incomplete.

We're currently getting this information from the virology experts to
the publishing person. Updates will be forthcoming! Because different
regimens are approved in different jurisdictions, we expect to have to
update this table fairly frequently as we merge our first few
datasets.


\newpage
\section{Cause of Death codes}
\label{apx:cod}
\input{guides/cod_table}


\newpage
\section{Treatment Response Codes}
\label{apx:response}
\input{guides/response_table}

\end{appendices}


\end{document}
